---
title: "Andrea - Assessment 3"
author: "Andrea Botes"
date: "04/06/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(rtweet)
library(tidytext)
library(dplyr)
library(tidyr)
```

## Data import

Collect tweets about Luna

```{r}

luna_tweets<-search_tweets(
  q="luna",
  n=50,
  include_rts = TRUE,
  lang="en",
  retryonratelimit = TRUE
)

```

Cleaner version:

```{r}
#look at first 10 obs
luna_tweets%>%
  head(10)

#look at structure
luna_tweets%>%
  str()
  
luna_short<-luna_tweets %>%
  select(user_id , screen_name , created_at , text , favorite_count, retweet_count, urls_expanded_url, hashtags, mentions_screen_name, location)

luna_short%>%write_csv("luna_short_04_06_2022.csv")
luna_tweets<-read_csv("luna_short_04_06_22.csv")
```

# Part 3: Topic Modeling & visualisation
  
## Preprocess text from dataset to tidy text & convert to DocumenttermMatric

### Clean up dataset text

```{r}
tidy_luna <- luna_short %>%
  mutate(text) %>%
  unnest_tokens(word , text) %>%
  anti_join(get_stopwords()) %>%
  filter(!is.na(word) & !grepl("[^A-Za-z]" , word) & word != "https" & word !="na")

tidy_luna %>%
  count(word , sort = TRUE)

```


```{r}
head(tidy_luna$word)

#remove stop words from list of words

cleaned_tidy_luna <- tidy_luna %>%
  anti_join(stop_words)
head(cleaned_tidy_luna)

head(tidy_luna$word)
```

# top 10 most commonly used words

```{r}
cleaned_tidy_luna %>%
  count(word, sort = TRUE) %>%
  top_n(10) %>%
  mutate(word = reorder(word, n)) %>%
  ggplot(aes(x = word , y= n)) +
  geom_col() +
  xlab(NULL) +
  coord_flip() +
  theme_classic() +
  labs(x = "Count" , 
       y = "Unique words" , 
       title = "Unique word counts found in #luna tweets")

```

Sentiment analysis

A score greater than zero indicates positive sentiment, while a score less than zero would mean negative overall emotion. A calculated score of zero indicates neutral sentiment (neither positive or negative).

```{r}
library(tidytext)
library(textdata)

#Positive sentiment

get_sentiments("bing") %>% filter(sentiment=="positive")

get_sentiments("afinn") %>% filter(value=="3")

```



```{r}
#Negative sentiment

get_sentiments("bing") %>% filter(sentiment=="negative")

get_sentiments("afinn") %>% filter(value=="-3")


```

Sentiment on tweets
## bing sentiment analysis

```{r}
bing_luna = cleaned_tidy_luna %>%
  inner_join(get_sentiments("bing")) %>%
  count(word, sentiment, sort = TRUE) %>%
  ungroup()
```

Compare postive and negative analysis
```{r}
bing_luna %>%
  group_by(sentiment) %>%
  top_n(10) %>%
  ungroup() %>%
  mutate(word = reorder(word, n)) %>%
  ggplot(aes(word, n, fill = sentiment)) + 
  geom_col(show.legend = FALSE) +
  facet_wrap(~sentiment, scales = "free_y") +
  labs(title = "Tweets containing '#luna'", 
       y = "Contribution to sentiment" , 
       x = NULL) +
  coord_flip() + theme_bw()
```
```{r}
sentiment_bing = function(twt) {
  
  #Step 1; perform basic text cleaning (on tweet), as seen earlier
  
  twt_tbl = tibble(text = twt) %>%
    mutate(
      
      #remove http elements manually
      stripped_text = gsub("http\\s+" , "" , text)
    ) %>%
    unnest_tokens(word , stripped_text) %>%
    anti_join(stop_words) %>% #remove stop words
    inner_join(get_sentiments("bing")) %>% #merge with bing sentiment
    count(word , sentiment , sort = TRUE) %>%
    ungroup() %>%
    
    #create a column "score" , that assigns a -1 to all negative words and a 1 to positive words
    
    mutate(
      score = case_when(
        sentiment == 'negative'~n*(-1) , 
        sentiment == 'positive'~n*1)
      )
  ## Calculate total score
  
  sent.score = case_when(
    nrow(twt_tbl)==0~0 , #if therre are no words the score is 0
    nrow(twt_tbl)>0~sum(twt_tbl$score) #otherwise, sum the positive and negatives
  )
  
  ##This is to keep track of which tweets contained no words at all from the bing list
  zero.type = case_when(
    nrow(twt_tbl)==0~"Type 1", #type 1: no words at all, zero = no
    nrow(twt_tbl)>0~"Type 2" #type 2: zero means sum of words = 0
  )
  list(score = sent.score , type = zero.type , twt_tbl = twt_tbl)
}
```

Apply function to #luna dataset

```{r}
#The lapply function returns a list of all the sentiment scores, types, and tables of the tweets

luna_sentiment = lapply(luna_short$text, function(x){sentiment_bing(x)})
luna_sentiment
```

REFERENCES

https://towardsdatascience.com/twitter-sentiment-analysis-and-visualization-using-r-22e1f70f6967